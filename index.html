<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Mini‚ÄëGTA (mobile + d√©placement visible)</title>
<style>
  :root{
    --bg:#0e0f19; --hud:#16182a; --hud2:#23274a; --txt:#e9ecff; --muted:#aab1ff;
    --road:#424655; --lane:#d9dbdf; --grass:#1e6a3a; --building:#2a2e54; --door:#a7742a;
    --car:#ff5353; --police:#5aa6ff; --player:#ffd56a; --mission:#ffd44d;
    --shadow: rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:radial-gradient(900px 600px at 70% -10%,#1b1f3f 0,#0e0f19 60%);
    color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
    display:flex;align-items:center;justify-content:center;overflow:hidden;
  }
  .wrap{width:min(1100px,96vw);height:min(700px,92vh);position:relative;border:1px solid #29305f;border-radius:16px;background:linear-gradient(180deg,rgba(24,27,60,.85),rgba(10,12,28,.85));overflow:hidden;box-shadow:0 10px 40px var(--shadow)}
  header{position:absolute;inset:12px 12px auto 12px;z-index:3;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .hud{display:flex;gap:8px;padding:6px;border-radius:12px;background:rgba(10,12,28,.6);border:1px solid #2a2f62}
  .stat{padding:.35rem .6rem;border-radius:10px;background:var(--hud);border:1px solid #2a2f62;font-variant-numeric:tabular-nums}
  .btn{appearance:none;border:1px solid #2a2f62;background:var(--hud2);color:var(--txt);border-radius:10px;padding:.55rem .8rem;cursor:pointer}
  canvas{position:absolute;inset:60px 0 0 0;display:block;width:100%;height:calc(100% - 60px);background:#0a0b16;touch-action:none}
  footer{position:absolute;inset:auto 12px 12px 12px;display:flex;align-items:center;justify-content:space-between;z-index:2}
  .tips{color:var(--muted)}
  /* Mobile controls */
  .controls{position:absolute;inset:auto 12px 12px 12px; display:flex; justify-content:space-between; align-items:flex-end; gap:12px; z-index:4; pointer-events:none}
  .joystick{width:140px;height:140px;border-radius:50%;background:rgba(20,24,48,.35);border:1px solid #2a2f62;position:relative;pointer-events:auto;touch-action:none}
  .stick{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:64px;height:64px;border-radius:50%;background:rgba(122,162,255,.5);border:1px solid #7aa2ff;box-shadow:0 6px 18px rgba(122,162,255,.25)}
  .actions{display:flex;gap:10px;pointer-events:auto}
  .abtn{width:64px;height:64px;border-radius:14px;border:1px solid #2a2f62;background:rgba(20,24,48,.6);color:var(--txt);font-weight:700}
  @media (max-width:720px){
    header .hud .stat:nth-child(4){display:none}
  }
</style>
</head>
<body>
<div class="wrap" role="application" aria-label="Jeu d'aventure top‚Äëdown">
  <header>
    <div class="hud">
      <div class="stat">Mode: <b id="mode">√Ä pied</b></div>
      <div class="stat">Mission: <b id="missionTxt">Va au point ‚≠ê</b></div>
      <div class="stat">Recherche: <b id="wanted">0</b> ‚òÖ</div>
      <div class="stat">Vitesse: <b id="speed">0</b> km/h</div>
    </div>
    <div class="hud">
      <button id="restart" class="btn">üîÅ Recommencer</button>
      <button id="help" class="btn">‚ùì Aide</button>
    </div>
  </header>

  <canvas id="game" width="1100" height="640" aria-label="Zone de jeu"></canvas>

  <footer>
    <div class="tips">
      PC : ZQSD / ‚Üë‚Üì‚Üê‚Üí pour bouger ‚Ä¢ E entrer/sortir du v√©hicule ‚Ä¢ Espace = frein √† main ‚Ä¢ M mini‚Äëcarte
      ‚Äî Mobile : joystick + boutons Entrer / Frein
    </div>
  </footer>

  <!-- Mobile controls -->
  <div class="controls">
    <div class="joystick" id="joy"><div class="stick" id="stick"></div></div>
    <div class="actions">
      <button class="abtn" id="enterBtn">E</button>
      <button class="abtn" id="brakeBtn">‚üÇ</button>
    </div>
  </div>

  <!-- Help panel -->
  <div class="card" id="helpPanel" style="position:absolute;inset:0;display:none;place-items:center;z-index:5">
    <div class="panel" style="width:min(560px,92%);background:linear-gradient(180deg,rgba(28,32,82,.96),rgba(14,16,36,.96));border:1px solid #2a2f62;border-radius:14px;padding:18px;box-shadow:0 0 24px rgba(90,166,255,.25)">
      <h2>Commandes</h2>
      <ul class="tips">
        <li><b>PC :</b> ZQSD / Fl√®ches pour bouger, E pour entrer/sortir, Espace = frein</li>
        <li><b>Mobile :</b> Joystick pour bouger/diriger, boutons <b>E</b> (entrer/sortir) et <b>‚üÇ</b> (frein)</li>
      </ul>
      <div style="text-align:center;margin-top:.5rem"><button class="btn" id="closeHelp">OK</button></div>
    </div>
  </div>
</div>

<script>
(()=>{'use strict';

  // ------- Canvas setup -------
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');

  function fit(){
    const r = cvs.parentElement.getBoundingClientRect();
    const w = r.width, h = r.height - 60;
    const ratio = 1100/640;
    let cw = w, ch = cw/ratio;
    if(ch>h){ ch=h; cw=ch*ratio; }
    cvs.style.width = cw+'px';
    cvs.style.height = ch+'px';
  }
  addEventListener('resize', fit); fit();

  // ------- World (grid) -------
  const W = cvs.width, H = cvs.height, TS = 40;
  const cols = Math.floor(W/TS), rows = Math.floor(H/TS);

  const roadsY = [4, 10, 15];
  const roadsX = [6, 13, 20];
  const isRoad = (x,y)=> roadsY.includes(y) || roadsX.includes(x);

  const buildings = [];
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      if(!isRoad(x,y) && Math.random()<0.18){
        buildings.push({x, y, w:1, h:1});
      }
    }
  }

  // Mission
  const mission = { x: (cols-3)*TS+TS/2, y: 4*TS+TS/2, r: 16, done:false };

  // ------- Entities -------
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function dist(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return Math.hypot(dx,dy); }
  function collidesWithBuilding(x,y,r=10){
    const gx=Math.floor(x/TS), gy=Math.floor(y/TS);
    return buildings.some(b => gx>=b.x && gx<b.x+b.w && gy>=b.y && gy<b.y+b.h);
  }

  const player = { x: 5.5*TS, y: 4.5*TS, r: 10, angle:0, onFoot:true, speed:0, maxFoot:2.2 };
  const car = { x: 8.5*TS, y: 10.5*TS, w: 28, h:16, angle:0, speed:0, max:4.0, accel:.18, fric:.06 };
  const police = { x: 20.5*TS, y: 10.5*TS, w: 30, h:18, angle:0, speed:0, max:3.8, accel:.16, fric:.06, active:false, cool:0 };
  let wanted = 0;

  // ------- Input (keyboard) -------
  const keys = new Set();
  addEventListener('keydown', e=>{ keys.add(e.key.toLowerCase()); if(['arrowup','arrowdown','arrowleft','arrowright',' '].includes(e.key.toLowerCase())) e.preventDefault(); });
  addEventListener('keyup', e=> keys.delete(e.key.toLowerCase()));
  const key = k => keys.has(k) || keys.has({'z':'w','q':'a','s':'s','d':'d'}[k]||'_'); // ZQSD & WASD

  // ------- Mobile joystick -------
  const joy = document.getElementById('joy');
  const stick = document.getElementById('stick');
  const joyCenter = {x:0,y:0}; let joyVec = {x:0,y:0}; let joyActive = false;

  function joyPos(e){
    const t = e.touches? e.touches[0] : e;
    const rect = joy.getBoundingClientRect();
    return { x: t.clientX - rect.left, y: t.clientY - rect.top, r: Math.min(rect.width, rect.height)/2 };
  }
  function joyStart(e){
    e.preventDefault(); joyActive = true;
    const rect = joy.getBoundingClientRect();
    joyCenter.x = rect.width/2; joyCenter.y = rect.height/2;
  }
  function joyMove(e){
    if(!joyActive) return; e.preventDefault();
    const p = joyPos(e);
    const dx = p.x - joyCenter.x, dy = p.y - joyCenter.y;
    const len = Math.hypot(dx,dy) || 1;
    const max = p.r - 10;
    const nx = clamp(dx/len, -1, 1), ny = clamp(dy/len, -1, 1);
    const mag = Math.min(len, max);
    stick.style.transform = `translate(${mag*nx}px, ${mag*ny}px) translate(-50%,-50%)`;
    joyVec.x = nx; joyVec.y = ny;
  }
  function joyEnd(e){
    joyActive=false; joyVec.x=0; joyVec.y=0;
    stick.style.transform = 'translate(-50%,-50%)';
  }
  joy.addEventListener('pointerdown', joyStart);
  joy.addEventListener('pointermove', joyMove);
  addEventListener('pointerup', joyEnd);
  joy.addEventListener('touchstart', joyStart, {passive:false});
  joy.addEventListener('touchmove', joyMove, {passive:false});
  joy.addEventListener('touchend', joyEnd);

  // Mobile buttons
  const enterBtn = document.getElementById('enterBtn');
  const brakeBtn = document.getElementById('brakeBtn');
  enterBtn.addEventListener('click', ()=> toggleEnterExit());
  let brakeHeld = false;
  brakeBtn.addEventListener('pointerdown', ()=> brakeHeld=true);
  brakeBtn.addEventListener('pointerup', ()=> brakeHeld=false);
  brakeBtn.addEventListener('touchstart', ()=> brakeHeld=true, {passive:true});
  brakeBtn.addEventListener('touchend', ()=> brakeHeld=false);

  // Help UI
  const helpBtn = document.getElementById('help');
  const helpPanel = document.getElementById('helpPanel');
  document.getElementById('closeHelp').onclick = ()=> helpPanel.style.display='none';
  helpBtn.onclick = ()=> helpPanel.style.display='grid';
  document.getElementById('restart').onclick = ()=> location.reload();

  // ------- Enter/Exit vehicle -------
  function toggleEnterExit(){
    if(player.onFoot){
      const d = Math.hypot(player.x-car.x, player.y-car.y);
      if(d < 36){ player.onFoot=false; }
    }else{
      // exit near car side
      player.onFoot=true;
      player.x = car.x + Math.cos(car.angle+Math.PI/2)*18;
      player.y = car.y + Math.sin(car.angle+Math.PI/2)*18;
      player.speed = 0;
    }
    document.getElementById('mode').textContent = player.onFoot ? '√Ä pied' : 'V√©hicule';
  }
  addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='e') toggleEnterExit(); });

  // ------- Game loop -------
  const modeEl = document.getElementById('mode');
  const missionEl = document.getElementById('missionTxt');
  const wantedEl = document.getElementById('wanted');
  const speedEl = document.getElementById('speed');

  let last = performance.now();
  function loop(now){
    const dt = Math.min(32, now-last); last = now;
    update(dt/16.666);
    render();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // ------- Update -------
  function update(dt){
    // Movement
    if(player.onFoot){
      const spd = player.maxFoot;
      // keyboard
      let dx = (key('d')||keys.has('arrowright') ? 1 : 0) - (key('q')||keys.has('arrowleft') ? 1 : 0);
      let dy = (key('s')||keys.has('arrowdown') ? 1 : 0) - (key('z')||keys.has('arrowup') ? 1 : 0);
      // joystick (mobile)
      dx += joyVec.x; dy += joyVec.y;

      // normalize
      const len = Math.hypot(dx,dy) || 1; dx/=len; dy/=len;
      const nx = player.x + dx*spd*dt*60;
      const ny = player.y + dy*spd*dt*60;

      // collision simple
      if(!collidesWithBuilding(nx, player.y)) player.x = clamp(nx, 8, W-8);
      if(!collidesWithBuilding(player.x, ny)) player.y = clamp(ny, 8, H-8);

      player.angle = Math.atan2(dy,dx)||player.angle;
      speedEl.textContent = '0';
    } else {
      // driving
      const steerLeft = key('q')||keys.has('arrowleft') || (joyActive && joyVec.x < -0.35);
      const steerRight= key('d')||keys.has('arrowright')|| (joyActive && joyVec.x > 0.35);
      const accelerate = key('z')||keys.has('arrowup')   || (joyActive && joyVec.y < -0.35); // up on stick
      const brakeKey   = key('s')||keys.has('arrowdown') || (joyActive && joyVec.y > 0.35);
      const handbrake  = keys.has(' ') || brakeHeld;

      if (accelerate) car.speed = Math.min(car.max, car.speed + car.accel*dt);
      else if (brakeKey) car.speed = Math.max(-car.max*.5, car.speed - car.accel*dt);
      else car.speed += (0 - car.speed) * car.fric*dt;

      const turn = (steerLeft?-1:0) + (steerRight?1:0);
      car.angle += turn * 0.045 * dt * (handbrake?1.6:1) * (car.speed? (Math.abs(car.speed)/car.max+0.3):0);

      const vx = Math.cos(car.angle) * car.speed * 60*dt;
      const vy = Math.sin(car.angle) * car.speed * 60*dt;

      // move & collide
      const nx = clamp(car.x + vx, 20, W-20);
      const ny = clamp(car.y + vy, 20, H-20);
      if(!collidesWithBuilding(nx, car.y)) car.x = nx; else car.speed *= -0.3;
      if(!collidesWithBuilding(car.x, ny)) car.y = ny; else car.speed *= -0.3;

      speedEl.textContent = Math.max(0, Math.round(Math.abs(car.speed)*22));
    }

    // Police chase if wanted>0 (simple follow)
    if(wanted>0 && !police.active) police.active = true;
    if(police.active){
      const tx = player.onFoot ? player.x : car.x;
      const ty = player.onFoot ? player.y : car.y;
      const ang = Math.atan2(ty-police.y, tx-police.x);
      police.angle += (ang - police.angle) * 0.08*dt;
      police.speed = Math.min(police.max, police.speed + police.accel*dt);
      police.x += Math.cos(police.angle)*police.speed*60*dt;
      police.y += Math.sin(police.angle)*police.speed*60*dt;

      // catch
      const catchDist = player.onFoot? 16 : 24;
      const px = player.onFoot? player.x : car.x;
      const py = player.onFoot? player.y : car.y;
      if(dist(police.x,police.y,px,py) < catchDist){
        wanted = 0; police.active=false; police.x = 20.5*TS; police.y = 10.5*TS; police.speed=0;
        if(player.onFoot){ player.x=5.5*TS; player.y=4.5*TS; } else { car.x=8.5*TS; car.y=10.5*TS; car.speed=0; }
      }
      police.cool += dt;
      if(police.cool>10 && wanted>0){ wanted--; police.cool=0; if(wanted===0) police.active=false; }
    }

    // Mission
    const cx = player.onFoot? player.x : car.x;
    const cy = player.onFoot? player.y : car.y;
    if(!mission.done && dist(cx,cy, mission.x, mission.y) < mission.r+10){
      mission.done=true;
      document.getElementById('missionTxt').textContent = 'Termin√© ‚úÖ';
    }

    wantedEl.textContent = wanted;
  }

  // ------- Render -------
  function render(){
    ctx.clearRect(0,0,W,H);

    // tiles
    for(let y=0;y<rows;y++){
      for(let x=0;x<cols;x++){
        const t = isRoad(x,y) ? 1 : 0;
        ctx.fillStyle = t? getCSS('--road') : getCSS('--grass');
        ctx.fillRect(x*TS, y*TS, TS, TS);
        if(t){
          ctx.strokeStyle = getCSS('--lane'); ctx.lineWidth = 2;
          if(roadsX.includes(x)){ ctx.beginPath(); ctx.moveTo(x*TS+TS/2, y*TS+6); ctx.lineTo(x*TS+TS/2, y*TS+TS-6); ctx.stroke(); }
          if(roadsY.includes(y)){ ctx.beginPath(); ctx.moveTo(x*TS+6, y*TS+TS/2); ctx.lineTo(x*TS+TS-6, y*TS+TS/2); ctx.stroke(); }
        }
      }
    }
    // buildings
    ctx.fillStyle = getCSS('--building');
    buildings.forEach(b=> ctx.fillRect(b.x*TS, b.y*TS, TS, TS));
    ctx.fillStyle = getCSS('--door');
    buildings.forEach(b=>{ if((b.x%2===0)&&(b.y%2===0)) ctx.fillRect(b.x*TS+TS/2-4, b.y*TS+TS-10, 8, 8); });

    // mission star
    if(!mission.done){
      drawStar(mission.x, mission.y, 5, 16, 7, getCSS('--mission'));
    }

    // car
    drawCar(car.x,car.y, car.w,car.h, car.angle, getCSS('--car'));
    // police
    if(police.active) drawCar(police.x,police.y, police.w,police.h, police.angle, getCSS('--police'));

    // player
    if(player.onFoot){
      ctx.fillStyle=getCSS('--player');
      ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2); ctx.fill();
      // nose
      ctx.strokeStyle='#000'; ctx.lineWidth=2;
      const nx = player.x + Math.cos(player.angle)*10;
      const ny = player.y + Math.sin(player.angle)*10;
      ctx.beginPath(); ctx.moveTo(player.x,player.y); ctx.lineTo(nx,ny); ctx.stroke();
    }
  }

  function drawCar(x,y,w,h,ang,color){
    ctx.save();
    ctx.translate(x,y); ctx.rotate(ang);
    ctx.fillStyle = color; ctx.strokeStyle='#000'; ctx.lineWidth=2;
    roundRect(-w/2,-h/2,w,h,4,true,true);
    ctx.fillStyle='rgba(230,244,255,.7)'; roundRect(-w/2+3,-h/2+3,w-6,h-6,3,true,false);
    ctx.restore();
  }
  function roundRect(x,y,w,h,r,fill,stroke){
    ctx.beginPath();
    ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r);
    if(fill) ctx.fill(); if(stroke) ctx.stroke();
  }
  function drawStar(cx,cy,spikes,outerR,innerR,color){
    let rot=Math.PI/2*3, x=cx, y=cy, step=Math.PI/spikes;
    ctx.save(); ctx.beginPath(); ctx.moveTo(cx,cy-outerR);
    for(let i=0;i<spikes;i++){
      x=cx+Math.cos(rot)*outerR; y=cy+Math.sin(rot)*outerR; ctx.lineTo(x,y); rot+=step;
      x=cx+Math.cos(rot)*innerR; y=cy+Math.sin(rot)*innerR; ctx.lineTo(x,y); rot+=step;
    }
    ctx.lineTo(cx,cy-outerR); ctx.closePath(); ctx.fillStyle=color; ctx.fill(); ctx.restore();
  }
  function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || '#fff'; }

})();</script>
</body>
</html>
